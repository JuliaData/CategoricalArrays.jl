<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Implementation details · CategoricalArrays</title><link rel="canonical" href="https://juliadata.github.io/CategoricalArrays.jl/stable/implementation/"/><link href="https://fonts.googleapis.com/css?family=Lato|Roboto+Mono" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.11.1/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="CategoricalArrays logo"/></a><div class="docs-package-name"><span class="docs-autofit">CategoricalArrays</span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Overview</a></li><li><a class="tocitem" href="../using/">Using CategoricalArrays</a></li><li class="is-active"><a class="tocitem" href>Implementation details</a></li><li><a class="tocitem" href="../apiindex/">API index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Implementation details</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Implementation details</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/JuliaData/CategoricalArrays.jl/blob/master/docs/src/implementation.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Implementation-details-1"><a class="docs-heading-anchor" href="#Implementation-details-1">Implementation details</a><a class="docs-heading-anchor-permalink" href="#Implementation-details-1" title="Permalink"></a></h1><p><code>CategoricalArray</code> is made of the two fields:</p><ul><li><code>refs</code>: an integer array that stores the position of the category level in the <code>levels</code> field of <code>CategoricalPool</code> for each <code>CategoricalArray</code> element; <code>0</code> denotes a missing value (for <code>CategoricalArray{Union{T, Missing}}</code> only).</li><li><code>pool</code>: the <code>CategoricalPool</code> object that maintains the levels of the array.</li></ul><p>The <code>CategoricalPool{V,R,C}</code> type keeps track of the levels of type <code>V</code> and associates them with an integer reference code of type <code>R</code> (for internal use). It offers methods to add new levels, and efficiently get the integer index corresponding to a level and vice-versa. Whether the values of <code>CategoricalArray</code> are ordered or not is defined by an <code>ordered</code> field of the pool.</p><p>Do note that <code>CategoricalPool</code> levels are semi-mutable: it is only allowed to add new levels, but never to remove or reorder existing ones. This ensures existing <code>CategoricalValue</code> objects remain valid and always point to the same level as when they were created. Therefore, <code>CategoricalArray</code>s create a new pool each time some of their levels are removed or reordered. This happens when calling <code>levels!</code>, but also when assigning a <code>CategoricalValue</code> via <code>setindex!</code>, <code>push!</code>, <code>append!</code>, <code>copy!</code> or <code>copyto!</code> (as new levels may be added to the front to preserve relative order of both source and destination levels). Doing so requires updating all reference codes to point to the new pool, and makes it impossible to compare existing ordered <code>CategoricalValue</code> objects with values from the array using <code>&lt;</code> and <code>&gt;</code>.</p><p>The type parameters of <code>CategoricalArray{T, N, R &lt;: Integer, V, C, U}</code> are a bit complex:</p><ul><li><code>T</code> is the type of array elements without <code>CategoricalValue</code> wrappers; if <code>T &gt;: Missing</code>, then the array supports missing values.</li><li><code>N</code> is the number of array dimensions.</li><li><code>R</code> is the reference type, the element type of the <code>refs</code> field; it allows optimizing memory usage depending on the number of levels (i.e. <code>CategoricalArray</code> with less than 256 levels can use <code>R = UInt8</code>).</li><li><code>V</code> is the type of the levels, it is equal to <code>T</code> for arrays which do not support missing values; for arrays which support missing values, <code>T = Union{V, Missing}</code></li><li><code>C</code> is the type of categorical values, i.e. of the objects returned when indexing non-missing elements of <code>CategoricalArray</code>. It is always equal to <code>CategoricalValue{V, R}</code>, and only present for technical reasons (to break the recursive dependency between <code>CategoricalArray</code> and <code>CategoricalValue</code>).</li><li><code>U</code> can be either <code>Union{}</code> for arrays which do not support missing values, or <code>Missing</code> for those which support them.</li></ul><p>Only <code>T</code>, <code>N</code> and <code>R</code> could be specified upon construction. The last three parameters are chosen automatically, but are needed for the definition of the type. In particular, <code>U</code> allows expressing that <code>CategoricalArray{T, N}</code> inherits from <code>AbstractArray{Union{C, U}, N}</code> (which is equivalent to <code>AbstractArray{C, N}</code> for arrays which do not support missing values, and to <code>AbstractArray{Union{C, Missing}, N}</code> for those which support them).</p><p>The <code>CategoricalPool</code> type is designed to limit the need to go over all elements of the vector, either for reading or for writing. This is why unused levels are not dropped automatically (this would force checking all elements on every modification or keeping a counts table), but only when <code>droplevels!</code> is called. <code>levels</code> is a (very fast) O(1) operation since it merely returns the (ordered) vector of levels without accessing the data at all.</p><p>Scalar operations between <code>CategoricalValue</code> objects or between a <code>CategoricalValue</code> and a <code>CategoricalArray</code> generally require checking whether pools are equal or whether one is a superset of the other. In order to make these operations efficient, <code>CategoricalPool</code> stores a pointer to the last encountered equal pool in the <code>equalto</code> field, and a pointer to the last encountered strict superset pool in <code>subsetof</code> field. The hash of the levels is computed the first time it is needed and stored in the <code>hash</code> field. These optimizations mean that when looping over values in an array, the cost of comparing pools only has to be paid once.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../using/">« Using CategoricalArrays</a><a class="docs-footer-nextpage" href="../apiindex/">API index »</a></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> on <span class="colophon-date" title="Friday 23 April 2021 21:27">Friday 23 April 2021</span>. Using Julia version 1.6.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
